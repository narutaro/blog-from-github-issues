<!doctype html>
<html class="no-js" lang="">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y0XWZZ2L8J"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-Y0XWZZ2L8J');
  </script>

  <meta charset="utf-8">
  <title>bf note</title>
  <meta name="description" content="A blog generated by Github issues">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# website: http://ogp.me/ns/website#">
  <meta property="og:title" content="narutaro/blog">
  <meta property="og:description" content="A blog genarated by Github issues">
  <meta property="og:type" content="bf note">
  <meta property="og:url" content="https:&#x2F;&#x2F;github.com&#x2F;narutaro&#x2F;blog&#x2F;issues&#x2F;28">
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4873581?v=4">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Place favicon.ico in the root directory -->

  <!-- Pico classless -->
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.classless.min.css">
  <link rel="stylesheet" href="/blog/css/theme.css">

  <!-- starry-night/style/high-contrast.css -->
  <link rel="stylesheet" href="/blog/css/dimmed.css">

  <!-- Fontawsome -->
  <script src="https://kit.fontawesome.com/a1763a7d6f.js" crossorigin="anonymous"></script>
</head>

<body>
  <header>
    <nav>
      <ul></ul>
      <ul>
        <li><a href="../"><i class="fa-solid fa-list-ol"></i></a></li>
        <li><a href="https:&#x2F;&#x2F;github.com&#x2F;narutaro&#x2F;blog&#x2F;issues&#x2F;28"><i class="fa-solid fa-gear"></i></a></li>
      </ul>
    </nav>
    <hgroup>
      <h1><i class="fa-brands fa-github"></i> bf note</h1>
      <h2><i class="fa-regular fa-calendar-days"></i>Sep 4th, 2022
      </h2>
    </hgroup>
  </header>

  <main>
    <h1>Reference</h1>
<p><a href="https://wisteriahill.sakura.ne.jp/CMS/WordPress/2021/03/06/jetson-nano-pose-estimation-resnet-18/" rel="nofollow">text book</a></p>
<ul>
<li>docker version 20.10.7 fails to launch the nvidia container. 20.10.2 works</li>
<li>container in the text book can be newer?? - may try again.</li>
</ul>
<p><a href="https://www.youtube.com/watch?v=y38Mze43w-A" rel="nofollow">Installation video</a></p>
<p><a href="https://github.com/NVIDIA-AI-IOT/trt_pose/blob/master/tasks/human_pose/live_demo.ipynb">trt_pose  - live_demo.ipynb</a></p>
<h1>Idea</h1>
<p>Why IoT Core</p>
<ul>
<li>Bi-redction - command to the device to reset the position, alert to the browser</li>
</ul>
<p>Detection</p>
<ul>
<li>State machine and alert</li>
<li><a href="https://dev.classmethod.jp/articles/aws-iot-events-conditional-expression/" rel="nofollow">https://dev.classmethod.jp/articles/aws-iot-events-conditional-expression/</a></li>
</ul>
<p>Visualization</p>
<ul>
<li>SiteWise with body hierarchy
<ul>
<li><a href="https://dev.classmethod.jp/articles/sitewise-monitor-multi-device/" rel="nofollow">Multiple sensors</a></li>
<li><a href="https://dev.classmethod.jp/articles/to-sitewise-via-iot-core/" rel="nofollow">IoT Core to SiteWise</a></li>
</ul>
</li>
<li>Timestream + Graphana</li>
</ul>
<p>Notification</p>
<ul>
<li>MQTT.js</li>
<li>Send reset as MQTT to Events</li>
</ul>
<h1>Procedure</h1>
<h2>Set timezone in container</h2>
<p>Overwrite <code class="notranslate">/etc/localtime</code> in the container with <code class="notranslate">/usr/share/zoneinfo/Japan</code> in the host.</p>
<h2>Create container</h2>
<div class="highlight highlight-source-shell"><pre>sudo docker create -it \
--name both_camera \
-p 8888:8888 \
--gpus all \
-e DISPLAY=<span class="pl-smi">$DISPLAY</span> \
-v /tmp/.X11-unix/:/tmp/.X11-unix \
--device /dev/video0:/dev/video0:mwr \
--device /dev/video1:/dev/video1:mwr \
-v /home/jetson/work-pose:/work \
nvcr.io/nvidia/l4t-ml:r32.5.0-py3</pre></div>
<h2>Install trt_pose</h2>
<ol>
<li>Install necessary stuffs refering the URLs above</li>
<li>Use <code class="notranslate">ipynb</code> file</li>
<li>Patch <code class="notranslate">/work/torch2trt/trt_pose/trt_pose/parse_objects.py</code> as follows</li>
</ol>
<div class="highlight highlight-source-diff"><pre>                     x = round(float(peak[1]) * width)
                     y = round(float(peak[0]) * height)
                     cv2.circle(image, (x, y), 3, color, 2)
<span class="pl-mi1"><span class="pl-mi1">+</span>                    with open("circle.log", "a+") as f:</span>
<span class="pl-mi1"><span class="pl-mi1">+</span>                        ts = datetime.datetime.now().isoformat()</span>
<span class="pl-mi1"><span class="pl-mi1">+</span>                        tis = tis = int(time.time())</span>
<span class="pl-mi1"><span class="pl-mi1">+</span>                        position = { "ts": ts, "tis": tis, "cid": j+1, "x": x, "y": x }</span>
<span class="pl-mi1"><span class="pl-mi1">+</span>                        f.write(json.dumps(position) + "\n")</span>
</pre></div>
<ol start="4">
<li>Build again</li>
</ol>
<pre class="notranslate"><code class="notranslate">cd /work/torch2trt/trt_pose
python3 setup.py install
</code></pre>
<h2>Install aws cli</h2>
<p><a href="https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-chap-getting-started.html" rel="nofollow">https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-chap-getting-started.html</a></p>
<p>Make sure you select <strong>Linux</strong> section and <strong>Linux ARM</strong> tab</p>
<p>You need install some packages before run the aws command</p>
<pre class="notranslate"><code class="notranslate">apt-get install less groff
</code></pre>
<h2>Setup a thing</h2>
<pre class="notranslate"><code class="notranslate">mkdir thing &amp;&amp; cd thing

aws iot create-thing --thing-name jetson

wget https://www.amazontrust.com/repository/AmazonRootCA1.pem

aws iot create-keys-and-certificate \
--set-as-active \ 
--certificate-pem-outfile "./device.pem.crt" \
--public-key-outfile "./public.pem.key" \
--private-key-outfile "./private.pem.key" \
&gt; certs-and-keys.json

aws iot attach-policy --policy-name p1 --target $(jq -r .certificateArn certs-and-keys.json)
</code></pre>
<h2>Install mosquitto</h2>
<p><a href="https://mosquitto.org/download/" rel="nofollow">https://mosquitto.org/download/</a></p>
<p>You may need to run this before</p>
<pre class="notranslate"><code class="notranslate">apt-get install software-properties-common
</code></pre>
<p>Then</p>
<pre class="notranslate"><code class="notranslate">apt-add-repository ppa:mosquitto-dev/mosquitto-ppa
apt-get update
apt-get install mosquitto-clients
</code></pre>
<h2>Publish test</h2>
<pre class="notranslate"><code class="notranslate">./shaper.sh ../circle.log.1 | mosquitto_pub --cafile AmazonRootCA1.pem --cert device.pem.crt --key private.pem.key -h a3su8icnk38ik7-ats.iot.ap-northeast-1.amazonaws.com -p 8883 -t pose -i jetson -d -l
</code></pre>
<p>You can check the messege coming in the web console</p>
<h2>Numbering</h2>
<pre class="notranslate"><code class="notranslate">more human_pose.json 
{"supercategory": "person", "id": 1, "name": "person", "keypoints": ["nose", "left_eye", "right_eye", "left_ear", "right_ear", "left_shoulder", "right_shoulder", "left_elbow", "right_elbow",
 "left_wrist", "right_wrist", "left_hip", "right_hip", "left_knee", "right_knee", "left_ankle", "right_ankle", "neck"], "skeleton": [[16, 14], [14, 12], [17, 15], [15, 13], [12, 13], [6, 8],
 [7, 9], [8, 10], [9, 11], [2, 3], [1, 2], [1, 3], [2, 4], [3, 5], [4, 6], [5, 7], [18, 1], [18, 6], [18, 7], [18, 12], [18, 13]]}
</code></pre>
<pre class="notranslate"><code class="notranslate">cat human_pose.json | jq .keypoints
[
  "nose",
  "left_eye",
  "right_eye",
  "left_ear",
  "right_ear",
  "left_shoulder",
  "right_shoulder",
  "left_elbow",
  "right_elbow",
  "left_wrist",
  "right_wrist",
  "left_hip",
  "right_hip",
  "left_knee",
  "right_knee",
  "left_ankle",
  "right_ankle",
  "neck"
]
</code></pre>
<p>Number and parts mapping is as follows.</p>
<ol>
<li>"nose",</li>
<li>"left_eye",</li>
<li>"right_eye",</li>
<li>"left_ear",</li>
<li>"right_ear",</li>
<li>"left_shoulder",</li>
<li>"right_shoulder",</li>
<li>"left_elbow",</li>
<li>"right_elbow",</li>
<li>"left_wrist",</li>
<li>"right_wrist",</li>
<li>"left_hip",</li>
<li>"right_hip",</li>
<li>"left_knee",</li>
<li>"right_knee",</li>
<li>"left_ankle",</li>
<li>"right_ankle",</li>
<li>"neck"</li>
</ol>
<pre class="notranslate"><code class="notranslate">     
224  x   0
---------+ 0
         |
         | y
         |
         | 224

</code></pre>
  </main>

  <footer>
    <small>Life is <a href="https://en.wiktionary.org/wiki/yak_shaving">yak shaving</a>.</small>
  </footer>
</body>

</html>

<style>
main>div>pre {
  font-size: 14px;
  line-height: var(--line-height);
  padding: var(--spacing);
}

body>header>hgroup>h2>i {
  padding-left: 0.5em;
  padding-right: 0.3em;
}
</style>
